#summary Processador Zet na placa Altera DE2-115.

= Processador Zet na placa Altera DE2-115 =
----

==Introdução==


O processador *Zet* é uma implementação aberta da arquitetura IA-32 (também conhecida como x86). Podendo ser sintetizado em placas FPGA, onde atualmente há 5 que são suportadas: _Altera DE0, DE1, DE2, DE2-155 e Xilinx ML403_.


No _[http://zet.aluzina.org/index.php/Zet_processor site do Zet]_ podemos encontrar informações mais detalhadas quanto à sua implementação, código fonte e também um guia de como sintetizá-lo na placa *_[http://zet.aluzina.org/index.php/Altera_DE1_Installation_guide Altera DE1]_*, que foi utilizado para entendermos e testarmos na placa *_DE2-115*_. 


Vamos descrever abaixo passo a passo como deve ser realizado este procedimento, recomendamos que seja feito primeiramente a *leitura atenta de cada item* para que não haja dúvidas e evite erros durante a implementação pois encontramos muitos problemas no guia do site do Zet, informações ambíguas, explicações que geravam dúvidas e informações jogadas o que torna esta experiência extremamente cansativa e frustrante, todos querem que tudo ocorra como esperado logo na primeira vez. :) 

----

== Antes de Começar ==
=== Periféricos ===
Obviamente é necessário que você possua uma placa Altera DE2-115 mas além dela são necessários alguns itens para que possamos utilizar o Zet:
  * Monitor com entrada vga
  * Cabo vga
  * Teclado PS2
  * Mouse PS2
  * Cartão SD de até 2GB

=== Quartus II ===
Utilizamos a versão do *Quartus II 12.1 _Web Edition_* disponível no site do [http://www.altera.com/index.jsp Altera] que pode ser encontrada [https://www.altera.com/download/dnl-index.jsp aqui]. 
Basta clicar na versão Windows ou Linux, baixar o instalador e durante o processo de instalação mudar para a versão *free*! Lembrando que é necessário ter um cadastro para realizar o download e para utilizar o Quartus II, mesmo que seja na versão free, caso contrário o mesmo não fará a compilação dos seus projetos.

_Observação: Para deixar sua licença funcional é necessário abrir o Quartus II, ir em *Tools/License Setup* clicar em Web License Update e escolher para realizar seu cadastro, após preencher todos os dados (será necessário inclusive o MAC Address da sua placa de rede) um arquivo .dat será enviado ao seu e-mail, baixe-o e atualize o arquivo dentro da opção License Setup do Quartus II._

=== DE2-115 Control Panel ===

O Control Panel é um software fornecido pelo Altera que funciona como um painel de controles para configurar e testar a placa, vamos utilizá-lo para escrever na memória FLASH e também para verificar se todas as entradas reconheceram os periféricos instalados.
Ele pode ser encontrado no CD que vem junto com a placa, mas também pode ser obtido [http://www.terasic.com.tw/cgi-bin/page/archive.pl?Language=English&CategoryNo=139&No=502&PartNo=4 aqui] em sua ultima versão.
Utilizamos a versão mais atualizada neste guia que é a v.1.0.6, após extrair o arquivo é possível encontrar o executável na pasta:
  * _DE2-115_V.1.0.6_SystemCD\DE2_115_tools\DE2_115_control_panel_

=== Preparando os arquivos ===
Recomendamos que seja criado uma pasta onde você deverá realizar o download de todos os arquivos necessários para que possamos implementar o Zet.

  * *[http://zet.aluzina.org/images/f/f5/Zet-1.2.0.zip Processador Zet]*: _está localizado na [http://zet.aluzina.org/index.php/Zet_processor página inicial] do Zet (a versão utilizada neste tutorial é a 1.2.0)_.
    # Extrair o zip para uma pasta qualquer, neste tutorial vamos utilizar a pasta _Zet-1.2.0_ (nome padrão do arquivo .zip)
    # Os arquivos utilizados serão: 
      * *bios.rom*: _localizado em Zet-1.2.0\src\bios_
      * *kotku.qpf*: _localizado em Zet-1.2.0\boards\altera-de2-115\syn_

  
  * *[http://zet.aluzina.org/images/e/e8/A-zet.zip Floppy Image]*: _Extrair o arquivo *a-zet.img* para a pasta._
  
  * *[http://zet.aluzina.org/images/9/9c/C.img.zip Hard Disk Image]*: _Extrair o arquivo *c.img* para a pasta._

Estes são os arquivos necessários para fazer nosso processador Zet funcionar!

----
== Botando a mão na massa! ==

=== Instalando os drivers da DE2-115 _(Windows)_ ===

Caso você já tenha utilizado a DE2-115 no seu computador e já a tenha configurado, não há a necessidade de seguir este passo, mas caso seja a primeira vez vamos ter de instalar o driver para que ela possa funcionar corretamente. 
Ligue a placa na energia e também no usb do seu computador, então aperte o botão de Power para ligá-la. Um programa pré-carregado vai começar a executar fazendo com que os leds e displays fiquem funcionando. Para instalar o driver basta localizá-lo na pasta onde você instalou o Altera:
  * C:\altera\12.1\quartus\drivers 

Não selecione nenhuma das pastas dentro de _drivers_ ou o driver não será reconhecido!

=== Criando a imagem da HD ===
*_Recomendamos fortemente utilizar Linux nesta etapa! Utilizamos o Ubuntu ;)_*

No *Linux* é muito simples de realizar este passo, utilizando o terminal, navegue até a pasta onde está localizado o arquivo _c.img_ e execute o seguinte comando:
{{{
dd if=./c.img of=/dev/sdc
}}}
_Observação: nem sempre o cartão estará em *sdc*, verifique antes de exceutar o comando_

No *Windows* é necessário utilizar um programa chamado [http://www.winimage.com/ WinImage], a versão do site é trial e funciona apenas 30 dias, com um pouco de esforço é possível achar a versão "[http://torrentz.eu/6977435afaa316876887cd018e102e35264412fc completa]". Nós não conseguimos entender como ele funciona, muito menos escrever corretamente no cartão SD utilizando ele, portanto fica por sua conta e risco.

=== Carregando arquivos na FLASH da DE2-115 ===

Agora vamos utilizar o *Control Panel*. Antes de abrir o executável, temos de abrir o arquivo _DE2_115_ControlPanel.sof_ no Quartus II e carregá-lo na DE2-115. Ao abrir o arquivo a janela _Programmer_ já será aberta automaticamente, basta clicar em _Start_, mas caso ela não apareça, é possível encontrá-la em _Tools/Programmer_.

Todos os _leds_ e filamentos dos _displays_ estarão acesos, agora já é possível abrir o executável _DE2_115_ControlPanel.exe_. Pode fechar o Quartus II pois o programa já está carregado na placa.

Vamos realizar os testes para ver se tudo está sendo reconhecido corretamente:
  * Cartão SD
    # Insira o cartão SD na lateral esquerda da placa, fica na parte de baixo.
    # Clique em *SD CARD* no Control Panel. 
    # Clique em *Read* e verifique se ele reconhece o cartão.

  * Outros testes podem ser realizados, fique à vontade para mexer no Control Panel.

Agora vamos carregar os arquivos na memória FLASH:
  # Clique em *Memory*.
  # Em _Memory Type_ escolha *_FLASH(400000h WORDS, 8MB)_*.
  # Clique em *Chip Erase (75 sec)*.
  # Aguarde o processo terminar.
  # Em Sequential Write selecione a box _*File Length*_.
  # Clique em _Write a File to Memory_.
  # Escolha o arquivos *_bios.rom_* localizado na pasta _Zet-1.2.0\src\bios_.
  # Aguarde o processo terminar.
  # Agora no _Address_ também dentro de _Sequential Write_ vamos mudá-lo para *00020000* _(4 zeros depois do 2)._
  # Clique em _Write a File to Memory_.
  # Escolha agora o arquivo *_a-zet.img_*
  # Aguarde o processo terminar.

Pronto! Já carregamos os arquivos necessários na memória FLASH da DE2-115, pode fechar o Control Panel.

=== Carregar o programa do Zet ===

Vamos abrir o projeto *_kotku.qpf_* localizado em _Zet-1.2.0\boards\altera-de2-115\syn_ no Quartus II. Após aberto, temos de compilá-lo, lembrando que caso você esteja usando a ultima versão do Quartus II é necessário estar com sua licença cadastrada, caso contrário ele não irá compilar! Clique em _Processing/Start Compilation_ ou simplesmente aperte _CTRL+L_. O processo de compilação é demorado, favor aguardar, já estamos quase no final!

Após compilado, vamos carregar o programa na DE2-115, abra o _Tools/Programmer_ e clique em _Start_ ! Pronto, nosso processador Zet já está funcionando!

=== Algumas observações ===
  * A chave *SW0* é o _Power ON/OFF_ utilize-a para ligar e desligar seu processador Zet.
  * Os leds estão exibindo FEld e no monitor está escrito: _No more devices to boot - System halted._
Neste caso a imagem do HD não foi escrito corretamente no cartão SD, é um problema usual, aqui nós simplesmente desistimos de entender como funciona o WinImage e partimos para o Ubuntu, utilizamos o comando no terminal e tudo funcionou corretamente, ele deixa apenas 50MB do cartão particionado como FAT16 e o resto não alocado.


----

<br>  
= Arquitetura do Zet =
----
== Considerações Iniciais ==
Primeiramente, vamos esclarecer algumas coisas  em relação a nomenclatura dos processadores:
  * Processadores 	IA-32: processadores da Intel baseados na arquitetura IA-32, e.g., 	8086/88, Intel 286, Intel386, Intel486, Pentium, Pentium Pro, Pentium II, Pentium III, Pentium 4 e Intel Xeon.
  * Processadores de 32-bits:  processadores IA-32 que usam arquitetura de 32-bits que inclui os processadores Intel386, Intel486, Pentium, Pentium Pro, Pentium II, Pentium III, Pentium 4 e Intel Xeon.
  * Processadores de 16-bits:  processadores IA-32 que usam arquitetura de 16-bits que inclui os processadores 8086/88 e o Intel 286

O Zet, processador implementado neste trabalho, é uma implementação da arquitetura IA-32 (x86), porém somente a parte 16-bits é suportada. Ele foi feito baseado no Intel 8086.
O conjunto de instruções do Zet suporta 89 das 92 instruções do 8086 e podem ser encontradas em http://zet.aluzina.org/index.php/Zet_status.

As 3 instruções não implementadas são wait, esc e lock, essas instruções foram desnecessárias pois não foi usado nenhum coprocessador. A falta deste coprocessador também acarretou no fato que o Zet não suporta instruções de ponto flutuante, pois o 8086 delegava estas instruções a um coprocessador Intel 8087 (vide http://www.cpu-world.com/CPUs/8086/index.html)

== Visão Geral ==

=== Aprovado por Cthulhu ===
[http://en.wikipedia.org/wiki/Cthulhu http://img838.imageshack.us/img838/8921/cthulhuv.jpg]